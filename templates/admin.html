{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       Modern Dashboard Design System
       Style: Minimalism + Clean Layout
       For: Admin Dashboard / B2B Enterprise
    ============================================ */
    
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .admin-header {
        margin-bottom: 2rem;
    }
    
    .admin-header h2 {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }
    
    /* 创建表单区域 - 使用网格布局 */
    .create-form-section {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .create-form-section .section-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #edf2f7;
    }
    
    /* 表单使用网格布局，合理分配空间 */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }
    
    .form-grid-full {
        grid-column: 1 / -1;
    }
    
    .form-grid .mb-3 {
        margin-bottom: 0.75rem !important;
    }
    
    /* 问卷列表区域 */
    .survey-list-section {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .survey-list-section .section-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #edf2f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* 灵活的卡片网格 - 根据屏幕自适应列数 */
    .survey-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
        width: 100%;
    }
    
    /* 响应式断点优化 */
    @media (min-width: 375px) {
        .survey-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }
    
    @media (min-width: 768px) {
        .survey-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.25rem;
        }
    }
    
    @media (min-width: 1024px) {
        .survey-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }
    }
    
    @media (min-width: 1440px) {
        .survey-grid {
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        }
    }
    
    /* 卡片项 - 确保宽度灵活 */
    .survey-card-item {
        min-width: 0;
        width: 100%;
        display: flex;
    }
    
    .survey-card-item > .card {
        width: 100%;
        min-width: 0;
        display: flex;
        flex-direction: column;
    }
    
    .survey-card-item .card-body {
        width: 100%;
        min-width: 0;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    
    /* 卡片内容优化 */
    .survey-card {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .survey-card:hover {
        border-color: #cbd5e0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }
    
    .survey-card .card-body {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .survey-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.75rem;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        min-height: 2.8em;
    }
    
    .survey-meta {
        margin-bottom: 1rem;
        flex-shrink: 0;
    }
    
    .survey-actions {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    /* 表单元素优化 */
    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #cbd5e0;
        padding: 0.5rem 0.75rem;
        transition: all 0.15s ease;
        font-size: 0.9375rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        outline: none;
    }
    
    .form-label {
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 0.4rem;
        font-size: 0.9375rem;
    }
    
    /* 滑动开关样式 */
    .toggle-switch-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: #f7fafc;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 56px;
        height: 28px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e0;
        transition: 0.3s;
        border-radius: 28px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background-color: #4299e1;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(28px);
    }
    
    .toggle-label {
        font-size: 0.9375rem;
        font-weight: 500;
        color: #4a5568;
        min-width: 80px;
    }
    
    .toggle-label.active {
        color: #2d3748;
        font-weight: 600;
    }
    
    /* 按钮优化 */
    .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.15s ease;
        cursor: pointer;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    /* 响应式表单布局 */
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .survey-grid {
            grid-template-columns: 1fr;
        }
        
        .admin-container {
            padding: 1rem 0.75rem;
        }
        
        .create-form-section,
        .survey-list-section {
            padding: 1rem;
        }
    }
    
    /* 无障碍优化 */
    .btn:focus-visible,
    .form-control:focus-visible,
    .form-select:focus-visible {
        outline: 2px solid #4299e1;
        outline-offset: 2px;
    }
    
    /* 减少动画（如果用户偏好） */
    @media (prefers-reduced-motion: reduce) {
        * {
            transition: none !important;
            animation: none !important;
        }
    }
</style>

<div class="admin-container">
    <div class="admin-header">
        <h2>问卷管理</h2>
    </div>
    
    <!-- 创建新问卷 -->
    <div class="create-form-section">
        <div class="section-header">创建新问卷</div>
        <form action="{{ url_for('create_survey') }}" method="post">
            <div class="form-grid">
                <div class="form-grid-full">
                    <label for="survey_name" class="form-label">问卷名称 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="survey_name" name="survey_name" 
                           placeholder="请输入问卷名称" required>
                </div>
                
                <div class="form-grid-full">
                    <label for="survey_introduction" class="form-label">问卷简介</label>
                    <textarea class="form-control" id="survey_introduction" name="survey_introduction" 
                              rows="2" placeholder="请输入问卷简介（可选）"></textarea>
                </div>
                
                <div class="form-grid-full">
                    <label for="subjective_question_prompt" class="form-label">主观题说明文字</label>
                    <textarea class="form-control" id="subjective_question_prompt" name="subjective_question_prompt" 
                              rows="2" placeholder="请输入主观题说明文字（可选）"></textarea>
                </div>
                
                <div>
                    <label class="form-label">问卷类型 <span class="text-danger">*</span></label>
                    <div class="toggle-switch-container mt-2">
                        <span class="toggle-label active" id="label-single">单选题问卷</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="survey_type_toggle" onchange="toggleSurveyType()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label" id="label-table">表格问卷</span>
                        <input type="hidden" name="survey_type" id="survey_type_input" value="single_choice">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">功能设置</label>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="enable_quick_fill" id="enable_quick_fill" checked>
                        <label class="form-check-label" for="enable_quick_fill">
                            启用快填功能
                        </label>
                        <small class="d-block text-muted mt-1" style="font-size: 0.8125rem;">
                            按住快填按钮自动选择第一个选项
                        </small>
                    </div>
                </div>
                
                <div class="form-grid-full mt-2">
                    <button type="submit" class="btn btn-primary">
                        创建问卷
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 现有问卷列表 -->
    <div class="survey-list-section">
        <div class="section-header">
            <span>现有问卷</span>
            {% if surveys %}
            <span class="badge bg-secondary">{{ surveys|length }}</span>
            {% endif %}
        </div>
        {% if survey_stats %}
        <div class="survey-grid">
            {% for stat in survey_stats %}
            {% set survey = stat.survey %}
            <div class="survey-card-item">
                <div class="card survey-card">
                    <div class="card-body">
                        <h6 class="survey-title" title="{{ survey.name }}">{{ survey.name }}</h6>
                        <div class="survey-meta">
                            <span class="badge bg-secondary">{{ '单选' if survey.type == 'single_choice' else '表格' }}</span>
                            {% if survey.type == 'table' %}
                            <span class="text-muted ms-2" style="font-size: 0.8125rem;">{{ 'ABCDE'[:survey.table_option_count] }}</span>
                            {% endif %}
                            <div class="mt-2">
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    已收集：<strong class="text-primary">{{ stat.total_count }}</strong> 条数据
                                </small>
                            </div>
                        </div>
                        <div class="survey-actions">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('preview_survey', survey_id=survey.id) }}" 
                                   class="btn btn-outline-info btn-sm" target="_blank" title="预览">预览</a>
                                <a href="{{ url_for('edit_survey', survey_id=survey.id) }}" 
                                   class="btn btn-outline-primary btn-sm" title="编辑">编辑</a>
                                <a href="{{ url_for('view_results', survey_id=survey.id) }}" 
                                   class="btn btn-outline-success btn-sm" title="查看结果">结果</a>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <form action="{{ url_for('copy_survey', survey_id=survey.id) }}" method="post" 
                                      onsubmit="return confirm('确定要复制问卷 \"{{ survey.name }}\" 吗？');" 
                                      style="display:inline; flex: 1;">
                                    <button type="submit" class="btn btn-outline-warning btn-sm w-100" title="复制">复制</button>
                                </form>
                                <form action="{{ url_for('delete_survey', survey_id=survey.id) }}" method="post" 
                                      onsubmit="return confirm('您确定要删除问卷 \"{{ survey.name }}\" 及其所有相关数据吗？此操作不可撤销！');" 
                                      style="display:inline; flex: 1;">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100" title="删除">删除</button>
                                </form>
                            </div>
                            <form action="{{ url_for('generate_qr', survey_id=survey.id) }}" method="post" class="mt-1">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm" id="num_users{{ survey.id }}" 
                                           name="num_users" min="1" value="10" required placeholder="数量" title="生成二维码数量">
                                    <button type="submit" class="btn btn-success btn-sm" title="生成二维码">生成</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">暂无问卷，请创建新问卷</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleSurveyType() {
        const toggle = document.getElementById('survey_type_toggle');
        const input = document.getElementById('survey_type_input');
        const labelSingle = document.getElementById('label-single');
        const labelTable = document.getElementById('label-table');
        
        if (toggle.checked) {
            input.value = 'table';
            labelSingle.classList.remove('active');
            labelTable.classList.add('active');
        } else {
            input.value = 'single_choice';
            labelSingle.classList.add('active');
            labelTable.classList.remove('active');
        }
    }
</script>
{% endblock %} 