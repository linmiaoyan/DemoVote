{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       ç¼–è¾‘é—®å·é¡µé¢æ ·å¼ä¼˜åŒ–
       ä¿æŒä¸æ•´ä½“é£æ ¼ä¸€è‡´
    ============================================ */
    
    .edit-page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #edf2f7;
    }
    
    .page-header h2 {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1a202c;
        margin: 0;
    }
    
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: #4299e1;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);
    }
    
    .btn-back:hover {
        background: #3182ce;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(66, 153, 225, 0.3);
    }
    
    .btn-back:active {
        transform: translateY(0);
    }
    
    .back-icon {
        font-size: 1.25rem;
        font-weight: bold;
        transition: transform 0.3s ease;
    }
    
    .btn-back:hover .back-icon {
        transform: translateX(-3px);
    }
    
    .section-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .section-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .section-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        padding: 1.25rem 1.5rem;
        margin: 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
        user-select: none;
        transition: background 0.2s ease;
    }
    
    .section-header:hover {
        background: #edf2f7;
    }
    
    .section-header-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-icon {
        font-size: 1.25rem;
        color: #4299e1;
    }
    
    .toggle-icon {
        font-size: 1.25rem;
        color: #718096;
        transition: transform 0.3s ease;
    }
    
    .toggle-icon.expanded {
        transform: rotate(180deg);
    }
    
    .section-content {
        padding: 1.5rem;
        display: none;
    }
    
    .section-content.show {
        display: block;
    }
    
    .section-card.always-visible .section-content {
        display: block;
    }
    
    .section-card.always-visible .section-header {
        cursor: default;
        background: #ffffff;
    }
    
    .section-card.always-visible .toggle-icon {
        display: none;
    }
    
    .section-header .btn {
        margin-left: auto;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }
    
    .form-grid-full {
        grid-column: 1 / -1;
    }
    
    .form-label {
        margin-bottom: 0.4rem;
        font-weight: 500;
    }
    
    .mb-3 {
        margin-bottom: 0.75rem !important;
    }
    
    /* æŠ˜å è¡¨å•æ ·å¼ */
    .collapse-form {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .collapse-form.hidden {
        display: none;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    /* é—®é¢˜åˆ—è¡¨æ ·å¼ä¼˜åŒ– */
    .question-list-container {
        margin-top: 1.5rem;
    }
    
    .batch-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f7fafc;
        border-radius: 8px;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .batch-actions-left {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .batch-actions-right {
        color: #718096;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .list-group {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .list-group-item {
        border: 1px solid #e2e8f0;
        border-bottom: none;
        padding: 1rem;
        transition: all 0.2s ease;
    }
    
    .list-group-item:last-child {
        border-bottom: 1px solid #e2e8f0;
    }
    
    .question-item-clickable {
        cursor: pointer;
        display: flex;
        align-items: start;
        gap: 0.75rem;
    }
    
    .question-item-clickable:hover {
        background-color: #f7fafc !important;
        border-color: #cbd5e0;
    }
    
    .question-content {
        flex: 1;
        min-width: 0;
    }
    
    .question-content h6 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 500;
        color: #2d3748;
        word-wrap: break-word;
    }
    
    .question-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .question-info {
        color: #718096;
        font-size: 0.875rem;
    }
    
    .question-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .question-actions .btn-group {
        display: flex;
        gap: 0.5rem;
    }
    
    /* è‡ªå®šä¹‰é€‰é¡¹æ ·å¼ */
    .custom-option-item {
        position: relative;
    }
    
    .custom-option-item .input-group {
        display: flex;
    }
    
    .custom-option-item .btn-outline-danger {
        padding: 0.375rem 0.75rem;
        border-color: #e53e3e;
        color: #e53e3e;
        transition: all 0.2s ease;
    }
    
    .custom-option-item .btn-outline-danger:hover:not(:disabled) {
        background: #e53e3e;
        color: white;
        border-color: #e53e3e;
    }
    
    .custom-option-item .btn-outline-danger:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #718096;
    }
    
    .empty-state p {
        margin: 0;
        font-size: 0.9375rem;
    }
    
    /* è¡¨å•æŒ‰é’®ç»„ */
    .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #edf2f7;
    }
    
    /* äººååˆ—è¡¨æ ·å¼ */
    .respondent-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s ease;
    }
    
    .respondent-item:last-child {
        border-bottom: none;
    }
    
    .respondent-item:hover {
        background-color: #f7fafc;
    }
    
    .respondent-name {
        font-weight: 500;
        color: #2d3748;
    }
    
    /* é€‰é¡¹é™åˆ¶è®¾ç½®ç½‘æ ¼ */
    .limit-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
    .drag-handle {
        cursor: grab;
        color: #a0aec0;
        font-size: 1.25rem;
        padding: 0.5rem;
        margin-right: 0.5rem;
        transition: color 0.2s ease;
        user-select: none;
        display: inline-flex;
        align-items: center;
    }
    
    .drag-handle:hover {
        color: #4299e1;
    }
    
    .drag-handle:active {
        cursor: grabbing;
    }
    
    .drag-handle::after {
        content: '';
        position: absolute;
        left: -5px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: transparent;
        transition: background 0.2s ease;
    }
    
    .drag-handle:hover::after {
        background: #4299e1;
    }
    
    .list-group-item.dragging {
        opacity: 0.4;
        background: #e2e8f0 !important;
        border: 2px dashed #cbd5e0 !important;
        transform: scale(0.98);
    }
    
    .list-group-item.drag-over {
        border-top: 4px solid #4299e1 !important;
        background: #ebf8ff !important;
    }
    
    .question-item-clickable {
        transition: all 0.2s ease;
        position: relative;
    }
    
    /* å ä½ç¬¦æ ·å¼ */
    .drag-placeholder {
        background: linear-gradient(135deg, #f7fafc 25%, transparent 25%, transparent 50%, #f7fafc 50%, #f7fafc 75%, transparent 75%, transparent) !important;
        background-size: 20px 20px !important;
        border: 3px dashed #4299e1 !important;
        position: relative;
    }
    
    .drag-placeholder::before {
        content: 'â¬‡ æ¾å¼€é¼ æ ‡æ”¾ç½®åˆ°è¿™é‡Œ';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #4299e1;
        font-weight: 600;
        font-size: 1rem;
        white-space: nowrap;
        pointer-events: none;
    }
    
    /* æ‹–æ‹½æç¤º */
    .drag-hint {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #4299e1;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        display: none;
        animation: fadeIn 0.3s ease;
    }
    
    .drag-hint.show {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .edit-page-container {
            padding: 1rem 0.75rem;
        }
        
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .btn-back {
            width: 100%;
            justify-content: center;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .batch-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .batch-actions-left {
            width: 100%;
        }
        
        .batch-actions-right {
            text-align: center;
        }
        
        .question-meta {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .question-actions {
            width: 100%;
            justify-content: flex-end;
        }
        
        .limit-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="edit-page-container">
    <div class="page-header">
        <h2>ç¼–è¾‘é—®å·ï¼š{{ survey.name }}</h2>
        <a href="{{ url_for('admin') }}" class="btn btn-back">
            <span class="back-icon">â†</span>
            è¿”å›ç®¡ç†é¡µé¢
        </a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSectionCard(this)">
            <div class="section-header-title">
                <span class="section-icon">ğŸ“</span>
                <span>åŸºæœ¬ä¿¡æ¯</span>
            </div>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="section-content">
            <form action="{{ url_for('update_survey_info', survey_id=survey.id) }}" method="post">
                <div class="form-grid">
                <div class="form-grid-full">
                    <label for="survey_name" class="form-label">é—®å·åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="survey_name" name="survey_name" 
                           value="{{ survey.name }}" required>
                </div>
                
                <div class="form-grid-full">
                    <label for="survey_introduction" class="form-label">é—®å·ç®€ä»‹</label>
                    <textarea class="form-control" id="survey_introduction" name="survey_introduction" 
                              rows="2">{{ survey.introduction or '' }}</textarea>
                    <small class="text-muted">éå¿…å¡«é¡¹</small>
                </div>
                
                <div class="form-grid-full">
                    <label for="subjective_question_prompt" class="form-label">ä¸»è§‚é¢˜è¯´æ˜æ–‡å­—</label>
                    <textarea class="form-control" id="subjective_question_prompt" name="subjective_question_prompt" 
                              rows="2">{{ survey.subjective_question_prompt or '' }}</textarea>
                    <small class="text-muted">éå¿…å¡«é¡¹</small>
                </div>
                
                {% if survey.type == 'table' %}
                <div>
                    <label for="table_option_count" class="form-label">é€‰é¡¹æ•°é‡</label>
                    <select class="form-select" id="table_option_count" name="table_option_count" required>
                        <option value="2" {% if survey.table_option_count==2 %}selected{% endif %}>2é¡¹ (A/B)</option>
                        <option value="3" {% if survey.table_option_count==3 %}selected{% endif %}>3é¡¹ (A/B/C)</option>
                        <option value="4" {% if survey.table_option_count==4 %}selected{% endif %}>4é¡¹ (A/B/C/D)</option>
                        <option value="5" {% if survey.table_option_count==5 %}selected{% endif %}>5é¡¹ (A/B/C/D/E)</option>
                    </select>
                    <small class="text-muted">ä¿®æ”¹é€‰é¡¹æ•°é‡ä¼šå½±å“æ‰€æœ‰é—®é¢˜</small>
                </div>
                {% endif %}
                
                <div>
                    <label class="form-label">åŠŸèƒ½è®¾ç½®</label>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="enable_quick_fill" id="enable_quick_fill" 
                               {% if survey.enable_quick_fill %}checked{% endif %}>
                        <label class="form-check-label" for="enable_quick_fill">
                            å¯ç”¨å¿«å¡«åŠŸèƒ½
                        </label>
                        <small class="d-block text-muted mt-1" style="font-size: 0.8125rem;">
                            æŒ‰ä½å¿«å¡«æŒ‰é’®è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
                        </small>
                    </div>
                </div>
                
                <div class="form-grid-full">
                    <button type="submit" class="btn btn-primary">ä¿å­˜åŸºæœ¬ä¿¡æ¯</button>
                </div>
            </div>
            </form>
        </div>
    </div>

    {% if survey.type == 'single_choice' %}
        <!-- æ‰¹é‡æ·»åŠ é—®é¢˜ -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ“</span>
                    <span>æ‰¹é‡æ·»åŠ æ ‡å‡†é—®é¢˜</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('edit_survey', survey_id=survey.id) }}" method="post">
                    <input type="hidden" name="action" value="import_list">
                    <div class="mb-3">
                        <label for="question_list" class="form-label">é—®é¢˜åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªé—®é¢˜ï¼‰</label>
                        <textarea class="form-control" id="question_list" name="question_list" 
                                  rows="10" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼š&#10;é—®é¢˜1&#10;é—®é¢˜2&#10;é—®é¢˜3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="option_count_batch" class="form-label">æ‰¹é‡é—®é¢˜é€‰é¡¹æ•°é‡</label>
                        <select class="form-select" id="option_count_batch" name="option_count_batch">
                            <option value="2">2ä¸ªé€‰é¡¹ (A/B)</option>
                            <option value="3">3ä¸ªé€‰é¡¹ (A/B/C)</option>
                            <option value="4" selected>4ä¸ªé€‰é¡¹ (A/B/C/D)</option>
                            <option value="5">5ä¸ªé€‰é¡¹ (A/B/C/D/E)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">æ‰¹é‡æ·»åŠ </button>
                </form>
            </div>
        </div>
        
        <!-- æ·»åŠ è‡ªå®šä¹‰å•é€‰ç»„ä»¶ -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ¨</span>
                    <span>æ·»åŠ è‡ªå®šä¹‰å•é€‰ç»„ä»¶</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('edit_survey', survey_id=survey.id) }}" method="post" id="custom_component_form">
                    <input type="hidden" name="action" value="add_custom_component">
                    <div class="mb-3">
                        <label for="custom_question_content" class="form-label">é¢˜ç›®å†…å®¹</label>
                        <input type="text" class="form-control" id="custom_question_content" name="custom_question_content" 
                               placeholder="ä¾‹å¦‚ï¼šå¡«å†™äººèº«ä»½" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰é¡¹åˆ—è¡¨</label>
                        <div id="custom_options_container">
                            <div class="custom-option-item mb-2">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="option_Z" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹ï¼Œä¾‹å¦‚ï¼šå…šå‘˜" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeCustomOption(this)" disabled>
                                        <span>âœ•</span>
                                    </button>
                                </div>
                            </div>
                            <div class="custom-option-item mb-2">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="option_Y" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹ï¼Œä¾‹å¦‚ï¼šç¾¤ä¼—" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeCustomOption(this)">
                                        <span>âœ•</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCustomOption()">
                            <span>ï¼‹</span> æ·»åŠ é€‰é¡¹
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ è‡ªå®šä¹‰ç»„ä»¶</button>
                </form>
            </div>
        </div>

        <!-- é€‰é¡¹é™åˆ¶è®¾ç½® -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">âš™ï¸</span>
                    <span>è®¾ç½®é€‰é¡¹é™åˆ¶</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('set_option_limits', survey_id=survey.id) }}" method="post">
                    <div class="limit-grid">
                        {% for option in 'ABCDE' %}
                        <div>
                            <label for="limit_{{ option }}" class="form-label">é€‰é¡¹ {{ option }} æœ€å¤§é€‰æ‹©æ¬¡æ•°</label>
                            <input type="number" class="form-control" id="limit_{{ option }}" 
                                   name="limit_{{ option }}" min="0" 
                                   value="{{ (survey.option_limits or {}).get(option, '') }}"
                                   placeholder="ä¸é™åˆ¶è¯·ç•™ç©º">
                        </div>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">ä¿å­˜é™åˆ¶è®¾ç½®</button>
                </form>
            </div>
        </div>

        <!-- é—®é¢˜åˆ—è¡¨ -->
        <div class="section-card always-visible">
            <div class="section-header">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ“‹</span>
                    <span>çºµè½´é—®é¢˜åˆ—è¡¨</span>
                </div>
            </div>
            <div class="section-content show">
                <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
                    <strong>ğŸ’¡ æ‹–æ‹½æ’åºæç¤ºï¼š</strong>
                    ç‚¹å‡»å¹¶æŒ‰ä½é—®é¢˜å·¦ä¾§çš„ <strong>â˜°</strong> å›¾æ ‡ï¼Œæ‹–åŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼ˆä¼šæ˜¾ç¤ºè™šçº¿æ¡†å’Œæç¤ºæ–‡å­—ï¼‰ï¼Œç„¶åæ¾å¼€é¼ æ ‡å³å¯å®Œæˆæ’åºã€‚
                </div>
                <div class="question-list-container">
                    {% if questions %}
                    <form id="batchDeleteForm" action="{{ url_for('batch_delete_questions') }}" method="post">
                        <input type="hidden" name="survey_id" value="{{ survey.id }}">
                        <div class="batch-actions">
                            <div class="batch-actions-left">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="toggleSelectAll()">å…¨é€‰/å–æ¶ˆå…¨é€‰</button>
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é—®é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼');">
                                    æ‰¹é‡åˆ é™¤é€‰ä¸­
                                </button>
                            </div>
                            <div class="batch-actions-right" id="selected-count">å·²é€‰æ‹© 0 ä¸ªé—®é¢˜</div>
                        </div>
                        <div class="list-group" id="question-list">
                            {% for question in questions %}
                            <div class="list-group-item question-item-clickable" 
                                 data-question-id="{{ question.id }}"
                                 onclick="toggleQuestionCheckbox(this, {{ question.id }}, event)">
                                <input type="checkbox" class="form-check-input mt-2 question-checkbox" 
                                       name="question_ids" value="{{ question.id }}" 
                                       onchange="updateSelectedCount()"
                                       onclick="event.stopPropagation()">
                                <div class="question-content">
                                    <h6>{{ question.content }}</h6>
                                    {% if question.component_type == 'custom_single_choice' %}
                                    <span class="badge bg-info mb-2">è‡ªå®šä¹‰å•é€‰ç»„ä»¶</span>
                                    {% else %}
                                    <span class="badge bg-secondary mb-2">æ ‡å‡†é—®é¢˜</span>
                                    {% endif %}
                                    <div class="question-meta">
                                        <span class="question-info">
                                            {% if question.component_type == 'custom_single_choice' and question.custom_options %}
                                                è‡ªå®šä¹‰é€‰é¡¹: 
                                                {% for key, value in question.custom_options.items() %}
                                                    {{ key }}.{{ value }}{% if not loop.last %}ï¼Œ{% endif %}
                                                {% endfor %}
                                            {% else %}
                                                é€‰é¡¹æ•°é‡: {{ question.option_count }}ï¼Œé€‰é¡¹: {{ 'ABCDE'[:question.option_count] }}
                                            {% endif %}
                                        </span>
                                        <div class="question-actions" onclick="event.stopPropagation()">
                                            <div class="btn-group btn-group-sm me-2">
                                                {% if not loop.first %}
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        onclick="moveQuestion({{ question.id }}, 'top', {{ survey.id }})" 
                                                        title="ç½®é¡¶">â‡ˆ</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        onclick="moveQuestion({{ question.id }}, 'up', {{ survey.id }})" 
                                                        title="ä¸Šç§»">â†‘</button>
                                                {% endif %}
                                                {% if not loop.last %}
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        onclick="moveQuestion({{ question.id }}, 'down', {{ survey.id }})" 
                                                        title="ä¸‹ç§»">â†“</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        onclick="moveQuestion({{ question.id }}, 'bottom', {{ survey.id }})" 
                                                        title="ç½®åº•">â‡Š</button>
                                                {% endif %}
                                            </div>
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    data-question-id="{{ question.id }}"
                                                    data-question-content='{{ question.content|tojson }}'
                                                    data-option-count="{{ question.option_count }}"
                                                    onclick="editQuestion(this)">
                                                ç¼–è¾‘
                                            </button>
                                            <form action="{{ url_for('delete_question', question_id=question.id) }}" method="post" 
                                                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜å—ï¼Ÿ');" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                    {% else %}
                    <div class="empty-state">
                        <p>æš‚æ— é—®é¢˜ï¼Œè¯·æ·»åŠ é—®é¢˜</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘é—®é¢˜çš„è¡¨å• -->
        <div class="section-card" id="editQuestionCard" style="display: none;">
            <div class="section-header">ç¼–è¾‘é—®é¢˜</div>
            <form id="editQuestionForm" method="post">
                <div class="mb-3">
                    <label for="edit_question_content" class="form-label">é—®é¢˜å†…å®¹</label>
                    <textarea class="form-control" id="edit_question_content" name="content" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="edit_option_count" class="form-label">é€‰é¡¹æ•°é‡</label>
                    <select class="form-select" id="edit_option_count" name="option_count">
                        <option value="2">2ä¸ªé€‰é¡¹ (A/B)</option>
                        <option value="3">3ä¸ªé€‰é¡¹ (A/B/C)</option>
                        <option value="4">4ä¸ªé€‰é¡¹ (A/B/C/D)</option>
                        <option value="5">5ä¸ªé€‰é¡¹ (A/B/C/D/E)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditQuestion()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

    {% else %}
        <!-- æ·»åŠ æ¨ªè½´é—®é¢˜ -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">â•</span>
                    <span>æ·»åŠ æ¨ªè½´é—®é¢˜</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('edit_survey', survey_id=survey.id) }}" method="post">
                    <input type="hidden" name="action" value="add_question">
                    <div class="mb-3">
                        <label for="table_content" class="form-label">é—®é¢˜å†…å®¹ï¼ˆåˆ—æ ‡é¢˜ï¼‰</label>
                        <textarea class="form-control" id="table_content" name="content" rows="2" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ æ¨ªè½´é—®é¢˜</button>
                </form>
            </div>
        </div>

        <!-- æ·»åŠ è‡ªå®šä¹‰å•é€‰ç»„ä»¶ -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ¨</span>
                    <span>æ·»åŠ è‡ªå®šä¹‰å•é€‰ç»„ä»¶</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('edit_survey', survey_id=survey.id) }}" method="post" id="table_custom_component_form">
                    <input type="hidden" name="action" value="add_custom_component">
                    <div class="mb-3">
                        <label for="table_custom_question_content" class="form-label">é¢˜ç›®å†…å®¹</label>
                        <input type="text" class="form-control" id="table_custom_question_content" name="custom_question_content" 
                               placeholder="ä¾‹å¦‚ï¼šå¡«å†™äººèº«ä»½" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰é¡¹åˆ—è¡¨</label>
                        <div id="table_custom_options_container">
                            <div class="custom-option-item mb-2">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="option_Z" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹ï¼Œä¾‹å¦‚ï¼šå…šå‘˜" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeTableCustomOption(this)" disabled>
                                        <span>âœ•</span>
                                    </button>
                                </div>
                            </div>
                            <div class="custom-option-item mb-2">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="option_Y" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹ï¼Œä¾‹å¦‚ï¼šç¾¤ä¼—" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeTableCustomOption(this)">
                                        <span>âœ•</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addTableCustomOption()">
                            <span>ï¼‹</span> æ·»åŠ é€‰é¡¹
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ è‡ªå®šä¹‰ç»„ä»¶</button>
                </form>
            </div>
        </div>

        <!-- é€‰é¡¹é™åˆ¶è®¾ç½® -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">âš™ï¸</span>
                    <span>è®¾ç½®é€‰é¡¹é™åˆ¶</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('set_option_limits', survey_id=survey.id) }}" method="post">
                    <div class="limit-grid">
                        {% for option in 'ABCDE'[:survey.table_option_count] %}
                        <div>
                            <label for="limit_{{ option }}_table" class="form-label">é€‰é¡¹ {{ option }} æœ€å¤§é€‰æ‹©æ¬¡æ•°</label>
                            <input type="number" class="form-control" id="limit_{{ option }}_table" 
                                   name="limit_{{ option }}" min="0" 
                                   value="{{ (survey.option_limits or {}).get(option, '') }}"
                                   placeholder="ä¸é™åˆ¶è¯·ç•™ç©º">
                        </div>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">ä¿å­˜é™åˆ¶è®¾ç½®</button>
                </form>
            </div>
        </div>

        <!-- é—®é¢˜åˆ—è¡¨ -->
        <div class="section-card always-visible">
            <div class="section-header">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ“‹</span>
                    <span>çºµè½´é—®é¢˜åˆ—è¡¨</span>
                </div>
            </div>
            <div class="section-content show">
                <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
                    <strong>ğŸ’¡ æ’åºæç¤ºï¼š</strong>
                    ä½¿ç”¨ <strong>â‡ˆ â†‘ â†“ â‡Š</strong> æŒ‰é’®å¯ä»¥è°ƒæ•´é—®é¢˜é¡ºåºï¼ˆç½®é¡¶ã€ä¸Šç§»ã€ä¸‹ç§»ã€ç½®åº•ï¼‰ã€‚
                </div>
                <div class="question-list-container">
                    {% if questions %}
                    <form id="batchDeleteTableForm" action="{{ url_for('batch_delete_questions') }}" method="post">
                        <input type="hidden" name="survey_id" value="{{ survey.id }}">
                        <div class="batch-actions">
                            <div class="batch-actions-left">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="toggleSelectAllTable()">å…¨é€‰/å–æ¶ˆå…¨é€‰</button>
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é—®é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼');">
                                    æ‰¹é‡åˆ é™¤é€‰ä¸­
                                </button>
                            </div>
                            <div class="batch-actions-right" id="selected-table-count">å·²é€‰æ‹© 0 ä¸ªé—®é¢˜</div>
                        </div>
                        <div class="list-group" id="table-question-list">
                            {% for question in questions %}
                            <div class="list-group-item question-item-clickable" 
                                 data-question-id="{{ question.id }}"
                                 onclick="toggleTableQuestionCheckbox(this, {{ question.id }}, event)">
                                <input type="checkbox" class="form-check-input mt-2 table-question-checkbox" 
                                       name="question_ids" value="{{ question.id }}" 
                                       onchange="updateSelectedTableCount()"
                                       onclick="event.stopPropagation()">
                                <div class="question-content">
                                    <h6>{{ question.content }}</h6>
                                    {% if question.component_type == 'custom_single_choice' %}
                                    <span class="badge bg-info mb-2">è‡ªå®šä¹‰å•é€‰ç»„ä»¶</span>
                                    <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                                        {% if question.custom_options %}
                                            é€‰é¡¹: 
                                            {% for key, value in question.custom_options.items() %}
                                                {{ key }}.{{ value }}{% if not loop.last %}ï¼Œ{% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </p>
                                    {% else %}
                                    <span class="badge bg-secondary mb-2">æ ‡å‡†é—®é¢˜</span>
                                    {% endif %}
                                </div>
                                <div class="question-actions" onclick="event.stopPropagation()">
                                    <div class="btn-group btn-group-sm me-2">
                                        {% if not loop.first %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="moveQuestion({{ question.id }}, 'top', {{ survey.id }})" 
                                                title="ç½®é¡¶">â‡ˆ</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="moveQuestion({{ question.id }}, 'up', {{ survey.id }})" 
                                                title="ä¸Šç§»">â†‘</button>
                                        {% endif %}
                                        {% if not loop.last %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="moveQuestion({{ question.id }}, 'down', {{ survey.id }})" 
                                                title="ä¸‹ç§»">â†“</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="moveQuestion({{ question.id }}, 'bottom', {{ survey.id }})" 
                                                title="ç½®åº•">â‡Š</button>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            data-question-id="{{ question.id }}"
                                            data-question-content='{{ question.content|tojson }}'
                                            onclick="editTableQuestion(this)">
                                        ç¼–è¾‘
                                    </button>
                                    <form action="{{ url_for('delete_question', question_id=question.id) }}" method="post" 
                                          onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜å—ï¼Ÿ');" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                    {% else %}
                    <div class="empty-state">
                        <p>æš‚æ— é—®é¢˜ï¼Œè¯·æ·»åŠ é—®é¢˜</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘è¡¨æ ¼é—®é¢˜çš„è¡¨å• -->
        <div class="section-card" id="editTableQuestionCard" style="display: none;">
            <div class="section-header">ç¼–è¾‘é—®é¢˜</div>
            <form id="editTableQuestionForm" method="post">
                <div class="mb-3">
                    <label for="edit_table_question_content" class="form-label">é—®é¢˜å†…å®¹ï¼ˆåˆ—æ ‡é¢˜ï¼‰</label>
                    <textarea class="form-control" id="edit_table_question_content" name="content" rows="2" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditTableQuestion()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

        <!-- å¯¼å…¥äººååˆ—è¡¨ -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSectionCard(this)">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ“</span>
                    <span>å¯¼å…¥äººååˆ—è¡¨</span>
                </div>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <form action="{{ url_for('edit_survey', survey_id=survey.id) }}" method="post">
                    <input type="hidden" name="action" value="import_respondents">
                    <div class="mb-3">
                        <label for="name_list" class="form-label">äººååˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªäººåï¼‰</label>
                        <textarea class="form-control" id="name_list" name="name_list" 
                                  rows="10" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªäººåï¼Œä¾‹å¦‚ï¼š&#10;å¶ä¸¹&#10;åˆ˜æµ·å²š&#10;é»„é’é’"></textarea>
                        <small class="text-muted mt-1 d-block">ğŸ’¡ æç¤ºï¼šåªè¾“å…¥ä¸€è¡Œä¹Ÿå¯ä»¥ï¼Œç”¨äºæ·»åŠ å•ä¸ªäººå</small>
                    </div>
                    <button type="submit" class="btn btn-success">å¯¼å…¥</button>
                </form>
            </div>
        </div>

        <!-- äººååˆ—è¡¨ -->
        <div class="section-card always-visible">
            <div class="section-header">
                <div class="section-header-title">
                    <span class="section-icon">ğŸ‘¥</span>
                    <span>äººååˆ—è¡¨</span>
                </div>
            </div>
            <div class="section-content show">
                <div class="question-list-container">
                    {% if respondents %}
                    <div class="list-group">
                        {% for respondent in respondents %}
                        <div class="list-group-item respondent-item">
                            <span class="respondent-name">{{ respondent.name }}</span>
                            <form action="{{ url_for('delete_respondent', respondent_id=respondent.id) }}" method="post" 
                                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤ \"{{ respondent.name }}\" å—ï¼Ÿ');" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger">åˆ é™¤</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <p>æš‚æ— äººåï¼Œè¯·æ·»åŠ äººå</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
    // ç¼–è¾‘å•é€‰é¢˜é—®é¢˜
    function editQuestion(button) {
        try {
            const questionId = button.getAttribute('data-question-id');
            const contentStr = button.getAttribute('data-question-content');
            const content = JSON.parse(contentStr);
            const optionCount = parseInt(button.getAttribute('data-option-count'));
            
            document.getElementById('edit_question_content').value = content;
            document.getElementById('edit_option_count').value = optionCount;
            document.getElementById('editQuestionForm').action = "{{ url_for('update_question', question_id=0) }}".replace('0', questionId);
            
            // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
            const editCard = document.getElementById('editQuestionCard');
            editCard.style.display = 'block';
            editCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (e) {
            console.error('ç¼–è¾‘é—®é¢˜æ—¶å‡ºé”™:', e);
            alert('ç¼–è¾‘é—®é¢˜æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
        }
    }

    // å–æ¶ˆç¼–è¾‘é—®é¢˜
    function cancelEditQuestion() {
        document.getElementById('editQuestionCard').style.display = 'none';
    }

    // ç¼–è¾‘è¡¨æ ¼é—®é¢˜
    function editTableQuestion(button) {
        try {
            const questionId = button.getAttribute('data-question-id');
            const contentStr = button.getAttribute('data-question-content');
            const content = JSON.parse(contentStr);
            
            document.getElementById('edit_table_question_content').value = content;
            document.getElementById('editTableQuestionForm').action = "{{ url_for('update_question', question_id=0) }}".replace('0', questionId);
            
            // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
            const editCard = document.getElementById('editTableQuestionCard');
            editCard.style.display = 'block';
            editCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (e) {
            console.error('ç¼–è¾‘é—®é¢˜æ—¶å‡ºé”™:', e);
            alert('ç¼–è¾‘é—®é¢˜æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
        }
    }

    // å–æ¶ˆç¼–è¾‘è¡¨æ ¼é—®é¢˜
    function cancelEditTableQuestion() {
        document.getElementById('editTableQuestionCard').style.display = 'none';
    }

    // åˆ‡æ¢æŠ˜å å¡ç‰‡
    function toggleSectionCard(header) {
        const card = header.parentElement;
        
        // å¦‚æœæ˜¯always-visibleï¼Œä¸å¤„ç†
        if (card.classList.contains('always-visible')) {
            return;
        }
        
        const content = card.querySelector('.section-content');
        const icon = header.querySelector('.toggle-icon');
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            icon.classList.remove('expanded');
        } else {
            content.classList.add('show');
            icon.classList.add('expanded');
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰ï¼ˆå•é€‰é¢˜ï¼‰
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.question-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
        updateSelectedCount();
    }

    // æ›´æ–°é€‰ä¸­æ•°é‡ï¼ˆå•é€‰é¢˜ï¼‰
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.question-checkbox:checked');
        const countElement = document.getElementById('selected-count');
        if (countElement) {
            countElement.textContent = `å·²é€‰æ‹© ${checkboxes.length} ä¸ªé—®é¢˜`;
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰ï¼ˆè¡¨æ ¼é¢˜ï¼‰
    function toggleSelectAllTable() {
        const checkboxes = document.querySelectorAll('.table-question-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
        updateSelectedTableCount();
    }

    // æ›´æ–°é€‰ä¸­æ•°é‡ï¼ˆè¡¨æ ¼é¢˜ï¼‰
    function updateSelectedTableCount() {
        const checkboxes = document.querySelectorAll('.table-question-checkbox:checked');
        const countElement = document.getElementById('selected-table-count');
        if (countElement) {
            countElement.textContent = `å·²é€‰æ‹© ${checkboxes.length} ä¸ªé—®é¢˜`;
        }
    }

    // ç‚¹å‡»æ•´ä¸ªæ¡ç›®åˆ‡æ¢å¤é€‰æ¡†ï¼ˆå•é€‰é¢˜ï¼‰
    function toggleQuestionCheckbox(itemElement, questionId, event) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–å¤é€‰æ¡†æœ¬èº«ï¼Œä¸å¤„ç†
        if (event && (event.target.closest('.question-actions') || event.target.closest('.form-check-input'))) {
            return;
        }
        const checkbox = itemElement.querySelector('.question-checkbox');
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            updateSelectedCount();
        }
    }

    // ç‚¹å‡»æ•´ä¸ªæ¡ç›®åˆ‡æ¢å¤é€‰æ¡†ï¼ˆè¡¨æ ¼é¢˜ï¼‰
    function toggleTableQuestionCheckbox(itemElement, questionId, event) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–å¤é€‰æ¡†æœ¬èº«ï¼Œä¸å¤„ç†
        if (event && (event.target.closest('.question-actions') || event.target.closest('.form-check-input'))) {
            return;
        }
        const checkbox = itemElement.querySelector('.table-question-checkbox');
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            updateSelectedTableCount();
        }
    }
    
    // æ‹–æ‹½æ’åºåŠŸèƒ½
    // ç§»åŠ¨é—®é¢˜é¡ºåº
    function moveQuestion(questionId, direction, surveyId) {
        fetch(`/admin/move_question/${questionId}/${direction}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°é¡ºåº
                location.reload();
            } else {
                alert('ç§»åŠ¨å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            console.error('ç§»åŠ¨å¤±è´¥:', error);
            alert('ç§»åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // ========== è‡ªå®šä¹‰å•é€‰ç»„ä»¶ - åŠ¨æ€é€‰é¡¹ç®¡ç†ï¼ˆé—®å·å‹ï¼‰ ==========
    let customOptionIndex = 2; // ä»Yå¼€å§‹ï¼ˆZã€Yå·²æœ‰ï¼‰
    const optionLetters = 'ZYXWVUTSRQPONMLKJIHGFEDCBA';  // é€†åºå­—æ¯ï¼Œé¿å…ä¸æ ‡å‡†é€‰é¡¹Aã€Bã€Cå†²çª
    
    function addCustomOption() {
        const container = document.getElementById('custom_options_container');
        const currentCount = container.querySelectorAll('.custom-option-item').length;
        
        if (currentCount >= 26) {
            alert('æœ€å¤šåªèƒ½æ·»åŠ 26ä¸ªé€‰é¡¹');
            return;
        }
        
        const nextLetter = optionLetters[currentCount];
        const div = document.createElement('div');
        div.className = 'custom-option-item mb-2';
        div.innerHTML = `
            <div class="input-group">
                <input type="text" class="form-control" name="option_${nextLetter}" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹" required>
                <button type="button" class="btn btn-outline-danger" onclick="removeCustomOption(this)">
                    <span>âœ•</span>
                </button>
            </div>
        `;
        container.appendChild(div);
        updateCustomDeleteButtons();
    }
    
    function removeCustomOption(button) {
        const container = document.getElementById('custom_options_container');
        const items = container.querySelectorAll('.custom-option-item');
        
        if (items.length <= 2) {
            alert('è‡³å°‘éœ€è¦ä¿ç•™2ä¸ªé€‰é¡¹');
            return;
        }
        
        button.closest('.custom-option-item').remove();
        
        // é‡æ–°åˆ†é…é€‰é¡¹åç§°ï¼ˆA, B, C...ï¼‰
        const remainingItems = container.querySelectorAll('.custom-option-item');
        remainingItems.forEach((item, index) => {
            const input = item.querySelector('input');
            input.name = 'option_' + optionLetters[index];
        });
        
        updateCustomDeleteButtons();
    }
    
    function updateCustomDeleteButtons() {
        const container = document.getElementById('custom_options_container');
        const items = container.querySelectorAll('.custom-option-item');
        const deleteButtons = container.querySelectorAll('.btn-outline-danger');
        
        deleteButtons.forEach((btn, index) => {
            btn.disabled = (items.length <= 2);
        });
    }
    
    // ========== è‡ªå®šä¹‰å•é€‰ç»„ä»¶ - åŠ¨æ€é€‰é¡¹ç®¡ç†ï¼ˆè¡¨æ ¼å‹ï¼‰ ==========
    function addTableCustomOption() {
        const container = document.getElementById('table_custom_options_container');
        const currentCount = container.querySelectorAll('.custom-option-item').length;
        
        if (currentCount >= 26) {
            alert('æœ€å¤šåªèƒ½æ·»åŠ 26ä¸ªé€‰é¡¹');
            return;
        }
        
        const nextLetter = optionLetters[currentCount];
        const div = document.createElement('div');
        div.className = 'custom-option-item mb-2';
        div.innerHTML = `
            <div class="input-group">
                <input type="text" class="form-control" name="option_${nextLetter}" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹" required>
                <button type="button" class="btn btn-outline-danger" onclick="removeTableCustomOption(this)">
                    <span>âœ•</span>
                </button>
            </div>
        `;
        container.appendChild(div);
        updateTableCustomDeleteButtons();
    }
    
    function removeTableCustomOption(button) {
        const container = document.getElementById('table_custom_options_container');
        const items = container.querySelectorAll('.custom-option-item');
        
        if (items.length <= 2) {
            alert('è‡³å°‘éœ€è¦ä¿ç•™2ä¸ªé€‰é¡¹');
            return;
        }
        
        button.closest('.custom-option-item').remove();
        
        // é‡æ–°åˆ†é…é€‰é¡¹åç§°ï¼ˆA, B, C...ï¼‰
        const remainingItems = container.querySelectorAll('.custom-option-item');
        remainingItems.forEach((item, index) => {
            const input = item.querySelector('input');
            input.name = 'option_' + optionLetters[index];
        });
        
        updateTableCustomDeleteButtons();
    }
    
    function updateTableCustomDeleteButtons() {
        const container = document.getElementById('table_custom_options_container');
        const items = container.querySelectorAll('.custom-option-item');
        const deleteButtons = container.querySelectorAll('.btn-outline-danger');
        
        deleteButtons.forEach((btn, index) => {
            btn.disabled = (items.length <= 2);
        });
    }
    
</script>
{% endblock %}
