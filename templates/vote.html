{% extends "base.html" %}

{% block content %}
{% if is_preview %}
<div class="alert alert-info mb-3" style="background-color: #bee5eb; border-left: 3px solid #17a2b8;">
    <strong>预览模式</strong> - 这是问卷的预览界面，不会保存任何提交的数据。
</div>
{% endif %}
<style>
    /* 强制表格数据单元格内容不换行，以便在小屏幕上启用横向滚动 */
    .table-responsive table td {
        white-space: nowrap;
    }
    /* 允许表格标题自动换行 */
    .table-responsive table th {
        white-space: normal;
    }
    /* 确保按钮组内的按钮也保持在一行 */
    .table-responsive .btn-group {
        flex-wrap: nowrap;
    }
    /* 增加表格列间距 */
    .table-responsive table td {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
    /* 增加表格标题列间距 */
    .table-responsive table th {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
    /* 增加按钮组内按钮间距 */
    .btn-group .btn {
        margin: 0 0.25rem;
    }
    /* 隔行交替颜色 - 扁平化 */
    .table tbody tr:nth-child(odd) td {
        background-color: #f0f0f0 !important; /* 浅灰色 */
    }
    .table tbody tr:nth-child(even) td {
        background-color: #ffffff !important; /* 白色 */
    }
    /* 确保表格列之间有框线 */
    .table.table-bordered th,
    .table.table-bordered td {
        border: 2px solid #abb9c6 !important; /* 强制显示边框 */
    }
    /* 添加选项限制提示样式 */
    .option-limit-info {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    .option-limit-warning {
        color: #dc3545;
        font-weight: bold;
    }
    /* 添加漏填提示样式 */
    .missing-field-alert {
        display: none;
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
</style>
<div class="container mt-4">
    <h2 style="color: #2d3748; font-weight: 600; margin-bottom: 1.5rem;">{{ survey.name }}</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} mt-3" role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if survey.introduction %}
    <div class="card mb-3 survey-intro">
        <div class="card-body" style="background-color: #edf2f7; border-left: 3px solid #4299e1;">
            <h4 style="margin-top:0; font-weight: 500; color: #2d3748;">问卷简介</h4>
            <p class="mb-0" style="color: #4a5568;">{{ survey.introduction }}</p>
        </div>
    </div>
    {% endif %}


    
    <form action="{% if is_preview %}#{% else %}{{ url_for('submit_vote', survey_id=survey.id) }}{% endif %}" method="{% if is_preview %}get{% else %}post{% endif %}" id="voteForm" {% if is_preview %}onsubmit="alert('预览模式下无法提交数据'); return false;"{% endif %}>
        {% if survey.type == 'single_choice' %}
            <!-- 单选题问卷 -->
            <!-- 快速填写按钮（圆形悬浮显示） -->
            <button type="button" id="quick-fill-btn" class="quick-fill-btn" title="按住自动选择第一个选项">按住快填</button>
            
            {% if survey.option_limits %}
            <div class="alert alert-info mb-3">
                <h5 class="alert-heading">选项限制说明</h5>
                <p class="mb-0">
                    {% for option, limit in survey.option_limits.items() %}
                    选项 {{ option }} 最多选择 {{ limit }} 次<br>
                    {% endfor %}
                </p>
            </div>
            {% endif %}
            
            {% for question in questions %}
            <div class="card mb-3 question-card">
                <div class="card-body">
                    <h5 class="card-title" style="font-weight: 600; margin-bottom: 1rem; color: #2c3e50;">{{ question.content }}</h5>
                    <div class="btn-group" role="group">
                        {% for option in 'ABCDE'[:question.option_count] %}
                        <input type="radio" class="btn-check" name="question_{{ question.id }}" 
                               id="q{{ question.id }}_{{ option }}" value="{{ option }}" required>
                        <label class="btn btn-outline-primary" for="q{{ question.id }}_{{ option }}">{{ option }}</label>
                        {% endfor %}
                    </div>
                    <div class="missing-field-alert" id="missing_{{ question.id }}">
                        请选择此问题的答案
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- 添加选项计数显示 -->
            {% if survey.option_limits %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">选项限制（提交时系统会自动核对数量）</h5>
                    <div id="optionCounts">
                        {% for option in survey.option_limits.keys() %}
                        <div class="option-limit-info">
                            选项 {{ option }}: <span id="count_{{ option }}">0</span>
                            / {{ survey.option_limits[option] }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
        {% elif survey.type == 'table' %}
            <!-- 表格问卷 -->
            <!-- 快速打分按钮（圆形悬浮显示） -->
            <button type="button" id="quick-score-btn" class="quick-fill-btn" title="按住自动选择第一个选项">按住快填</button>
            
            <!-- 分页控制（仅移动端显示） -->
            <div id="pagination-container" style="display: none;">
                <div class="pagination" id="pagination-controls"></div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered" id="vote-table">
                    <thead>
                        <tr>
                            <th> </th>
                            {% for question in questions %}
                            <th>{{ question.content }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="vote-table-body">
                        {% for respondent in respondents %}
                        <tr data-respondent-id="{{ respondent.id }}" class="respondent-row">
                            <td>{{ respondent.name }}</td>
                            {% for question in questions %}
                            <td>
                                <div class="btn-group" role="group">
                                    {% for option in 'ABCDE'[:table_option_count] %}
                                    <input type="radio" class="btn-check" 
                                           name="vote_{{ question.id }}_{{ respondent.id }}" 
                                           id="vote_{{ question.id }}_{{ respondent.id }}_{{ option }}" 
                                           value="{{ option }}" required>
                                    <label class="btn btn-outline-primary" 
                                           for="vote_{{ question.id }}_{{ respondent.id }}_{{ option }}">{{ option }}</label>
                                    {% endfor %}
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页信息 -->
            <div id="pagination-info" style="display: none; text-align: center; margin: 1rem 0; color: #666;">
                <span id="page-info-text"></span>
            </div>
        {% endif %}
        
        {% if subjective_question_prompt %}
        <div class="card mt-4 mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ subjective_question_prompt }}</h5>
                <div class="mb-3">
                    <textarea class="form-control" id="subjective_answer" name="subjective_answer" rows="5" 
                              placeholder="请在此处输入您的意见和建议..."></textarea>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">提交</button>
        </div>
    </form>
</div>

{% if survey.type == 'single_choice' and survey.option_limits %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const optionLimits = {{ survey.option_limits|tojson|safe }};
    const optionList = Object.keys(optionLimits);

    function updateOptionCounts() {
        const counts = {};
        optionList.forEach(opt => counts[opt] = 0);
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            const val = radio.value;
            if (counts[val] !== undefined) counts[val]++;
        });
        optionList.forEach(opt => {
            const countElem = document.getElementById(`count_${opt}`);
            if (countElem) {
                countElem.textContent = counts[opt];
            }
        });
    }

    // 绑定所有radio的change事件
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateOptionCounts);
    });

    // 页面加载时初始化一次
    updateOptionCounts();
});
</script>
{% endif %}

{% if survey.type == 'single_choice' %}
<script>
// 单选题问卷快速填写功能
document.addEventListener('DOMContentLoaded', function() {
    const quickFillBtn = document.getElementById('quick-fill-btn');
    if (quickFillBtn) {
        let isQuickFilling = false;
        let currentQuestionIndex = 0;
        let fillInterval = null;
        
        // 获取所有问题卡片（确保获取到所有包含radio的卡片）
        const questionCards = Array.from(document.querySelectorAll('.card.mb-3')).filter(card => {
            const hasRadio = card.querySelector('input[type="radio"]') !== null;
            return hasRadio;
        });
        
        console.log('找到问题卡片数量:', questionCards.length);
        
        function autoSelectFirstOption() {
            if (!isQuickFilling) return;
            
            if (currentQuestionIndex >= questionCards.length) {
                // 所有问题都填写完了
                stopQuickFilling();
                return;
            }
            
            const currentCard = questionCards[currentQuestionIndex];
            if (currentCard) {
                // 查找当前问题的第一个选项（第一个radio）
                const firstRadio = currentCard.querySelector('input[type="radio"]');
                if (firstRadio && !firstRadio.checked) {
                    // 先设置checked属性
                    firstRadio.checked = true;
                    
                    // 找到对应的label并触发点击（这样会更新样式）
                    const labelId = firstRadio.id;
                    const label = document.querySelector(`label[for="${labelId}"]`);
                    if (label) {
                        // 触发label的点击事件来更新样式
                        label.click();
                    }
                    
                    // 触发change事件，更新选项计数等
                    const changeEvent = new Event('change', { bubbles: true });
                    firstRadio.dispatchEvent(changeEvent);
                    
                    // 触发input事件
                    const inputEvent = new Event('input', { bubbles: true });
                    firstRadio.dispatchEvent(inputEvent);
                    
                    console.log('已选择问题', currentQuestionIndex + 1, '的选项', firstRadio.value);
                    
                    // 滚动到当前问题（延迟一点让选择生效）
                    setTimeout(() => {
                        currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
                
                // 移动到下一个问题
                currentQuestionIndex++;
            } else {
                currentQuestionIndex++;
            }
            
            // 继续下一个选择（稍快一些，但不是秒选）
            if (isQuickFilling) {
                fillInterval = setTimeout(autoSelectFirstOption, 150);
            }
        }
        
        // 查找第一个未填的问题索引
        function findFirstUnfilledQuestion() {
            for (let i = 0; i < questionCards.length; i++) {
                const card = questionCards[i];
                const radios = card.querySelectorAll('input[type="radio"]');
                let hasChecked = false;
                for (let radio of radios) {
                    if (radio.checked) {
                        hasChecked = true;
                        break;
                    }
                }
                if (!hasChecked) {
                    return i;
                }
            }
            return -1; // 所有问题都已填写
        }
        
        function startQuickFilling() {
            if (isQuickFilling) return;
            
            console.log('开始快速填写');
            
            // 查找第一个未填的问题，从未填的开始
            const firstUnfilledIndex = findFirstUnfilledQuestion();
            if (firstUnfilledIndex === -1) {
                // 所有问题都已填写
                alert('所有问题都已填写完成！');
                return;
            }
            
            isQuickFilling = true;
            quickFillBtn.classList.add('active');
            quickFillBtn.textContent = '填写中';
            
            // 从未填的问题开始
            currentQuestionIndex = firstUnfilledIndex;
            
            console.log('从未填的问题开始:', currentQuestionIndex + 1);
            
            // 开始自动选择
            autoSelectFirstOption();
        }
        
        function stopQuickFilling() {
            console.log('停止快速填写');
            isQuickFilling = false;
            quickFillBtn.classList.remove('active');
            quickFillBtn.textContent = '按住快填';
            
            if (fillInterval) {
                clearTimeout(fillInterval);
                fillInterval = null;
            }
        }
        
        // 触摸事件处理
        quickFillBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startQuickFilling();
        });
        
        quickFillBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            stopQuickFilling();
        });
        
        quickFillBtn.addEventListener('touchcancel', function(e) {
            e.preventDefault();
            stopQuickFilling();
        });
        
        // 鼠标事件处理
        quickFillBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            startQuickFilling();
        });
        
        quickFillBtn.addEventListener('mouseup', function(e) {
            e.preventDefault();
            stopQuickFilling();
        });
        
        quickFillBtn.addEventListener('mouseleave', function(e) {
            e.preventDefault();
            stopQuickFilling();
        });
    }
});
</script>
{% endif %}

{% if survey.type == 'table' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ITEMS_PER_PAGE = 20;
    let currentPage = 1;
    let isQuickScoring = false;
    let quickScoreInterval = null;
    
    // 检测是否为移动设备
    function isMobile() {
        return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // 获取所有行
    const allRows = Array.from(document.querySelectorAll('.respondent-row'));
    const totalRows = allRows.length;
    const totalPages = Math.ceil(totalRows / ITEMS_PER_PAGE);
    
    // showPage 函数定义（在移动设备上时使用）
    function showPage(page) {
        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        
        allRows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新分页信息
        const paginationInfo = document.getElementById('pagination-info');
        if (paginationInfo && paginationInfo.style.display !== 'none') {
            const infoText = document.getElementById('page-info-text');
            if (infoText) {
                infoText.textContent = `第 ${page} 页，共 ${totalPages} 页（每页 ${ITEMS_PER_PAGE} 人）`;
            }
        }
        
        // 更新分页按钮
        if (totalPages > 1) {
            updatePaginationButtons(page);
        }
        
        // 如果正在快速打分，查找新页面的第一个未填单元格
        if (isQuickScoring && typeof findFirstUnfilledCell === 'function') {
            const firstUnfilled = findFirstUnfilledCell();
            if (firstUnfilled) {
                currentRowIndex = firstUnfilled.rowIndex;
                currentQuestionIndex = firstUnfilled.questionIndex;
            } else {
                currentRowIndex = 0;
                currentQuestionIndex = 0;
            }
        }
    }
    
    // 更新分页按钮
    function updatePaginationButtons(page) {
        const controls = document.getElementById('pagination-controls');
        if (!controls) return;
        
        controls.innerHTML = '';
        
        // 上一页按钮
        const prevBtn = document.createElement('button');
        prevBtn.type = 'button';
        prevBtn.className = 'pagination-btn';
        prevBtn.textContent = '上一页';
        prevBtn.disabled = page === 1;
        prevBtn.onclick = () => {
            if (page > 1) {
                currentPage = page - 1;
                showPage(currentPage);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // 触发分页变化事件
                window.dispatchEvent(new Event('pagination-change'));
            }
        };
        controls.appendChild(prevBtn);
        
        // 页码显示
        const pageInfo = document.createElement('span');
        pageInfo.textContent = ` ${page} / ${totalPages} `;
        pageInfo.style.padding = '0 1rem';
        controls.appendChild(pageInfo);
        
        // 下一页按钮
        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'pagination-btn';
        nextBtn.textContent = '下一页';
        nextBtn.disabled = page === totalPages;
        nextBtn.onclick = () => {
            if (page < totalPages) {
                currentPage = page + 1;
                showPage(currentPage);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // 触发分页变化事件
                window.dispatchEvent(new Event('pagination-change'));
            }
        };
        controls.appendChild(nextBtn);
    }
    
    // 快速打分功能变量（需要在外面定义，以便在分页和快速打分中都能访问）
    let currentRowIndex = 0;
    let currentQuestionIndex = 0;
    
    // 快速打分按钮在所有设备上都显示（悬浮）
    const quickScoreBtn = document.getElementById('quick-score-btn');
    
    // 如果是移动设备，显示分页功能
    if (isMobile()) {
        const paginationContainer = document.getElementById('pagination-container');
        const paginationInfo = document.getElementById('pagination-info');
        
        // 只有多页时才显示分页功能
        if (totalPages > 1) {
            if (paginationContainer) paginationContainer.style.display = 'block';
            if (paginationInfo) paginationInfo.style.display = 'block';
            // 初始化第一页
            showPage(1);
        } else {
            // 如果只有一页，显示所有行
            allRows.forEach(row => {
                row.style.display = '';
            });
        }
    
        // 快速打分功能
        if (quickScoreBtn) {
        
        function autoSelectFirstOption() {
            if (!isQuickScoring) return;
            
            // 获取当前页面的所有行（按原始顺序）
            const visibleRows = [];
            allRows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    visibleRows.push({ row: row, originalIndex: index });
                }
            });
            
            if (visibleRows.length === 0) {
                // 当前页没有可见行，尝试切换到下一页
                if (currentPage < totalPages) {
                    currentPage++;
                    showPage(currentPage);
                    
                    // 查找下一页第一个未填的单元格
                    const nextUnfilled = findFirstUnfilledCell();
                    if (nextUnfilled) {
                        currentRowIndex = nextUnfilled.rowIndex;
                        currentQuestionIndex = nextUnfilled.questionIndex;
                    } else {
                        // 下一页也没有未填的，停止
                        stopQuickScoring();
                        return;
                    }
                    
                    setTimeout(autoSelectFirstOption, 300);
                } else {
                    // 所有页面都完成了
                    stopQuickScoring();
                }
                return;
            }
            
            // 获取当前行的数据
            const currentRowData = visibleRows[currentRowIndex];
            if (!currentRowData) {
                // 当前页已完成，切换到下一页
                if (currentPage < totalPages) {
                    currentPage++;
                    showPage(currentPage);
                    
                    // 查找下一页第一个未填的单元格
                    const nextUnfilled = findFirstUnfilledCell();
                    if (nextUnfilled) {
                        currentRowIndex = nextUnfilled.rowIndex;
                        currentQuestionIndex = nextUnfilled.questionIndex;
                    } else {
                        // 下一页也没有未填的，停止
                        stopQuickScoring();
                        return;
                    }
                    
                    setTimeout(autoSelectFirstOption, 300);
                } else {
                    // 所有页面都完成了
                    stopQuickScoring();
                }
                return;
            }
            
            const currentRow = currentRowData.row;
            
            // 获取当前行的所有选项组
            const btnGroups = currentRow.querySelectorAll('.btn-group');
            if (btnGroups.length === 0 || currentQuestionIndex >= btnGroups.length) {
                // 移动到下一行
                currentRowIndex++;
                currentQuestionIndex = 0;
                
                // 如果超出当前页，查找下一页第一个未填的
                if (currentRowIndex >= visibleRows.length) {
                    if (currentPage < totalPages) {
                        currentPage++;
                        showPage(currentPage);
                        
                        const nextUnfilled = findFirstUnfilledCell();
                        if (nextUnfilled) {
                            currentRowIndex = nextUnfilled.rowIndex;
                            currentQuestionIndex = nextUnfilled.questionIndex;
                        } else {
                            stopQuickScoring();
                            return;
                        }
                    } else {
                        stopQuickScoring();
                        return;
                    }
                }
                
                setTimeout(autoSelectFirstOption, 200);
                return;
            }
            
            // 选择当前问题的第一个选项
            const currentGroup = btnGroups[currentQuestionIndex];
            if (currentGroup) {
                const firstRadio = currentGroup.querySelector('input[type="radio"]');
                if (firstRadio && !firstRadio.checked) {
                    // 先设置checked属性
                    firstRadio.checked = true;
                    
                    // 找到对应的label并触发点击（这样会更新样式）
                    const labelId = firstRadio.id;
                    const label = currentGroup.querySelector(`label[for="${labelId}"]`);
                    if (label) {
                        // 触发label的点击事件来更新样式
                        label.click();
                    }
                    
                    // 触发change事件
                    const changeEvent = new Event('change', { bubbles: true });
                    firstRadio.dispatchEvent(changeEvent);
                    
                    // 触发input事件
                    const inputEvent = new Event('input', { bubbles: true });
                    firstRadio.dispatchEvent(inputEvent);
                    
                    console.log('已选择第', currentRowIndex + 1, '行第', currentQuestionIndex + 1, '题的选项', firstRadio.value);
                }
                
                // 移动到下一个问题
                currentQuestionIndex++;
                if (currentQuestionIndex >= btnGroups.length) {
                    // 当前行的所有问题都完成了，移动到下一行
                    currentRowIndex++;
                    currentQuestionIndex = 0;
                    
                    // 检查是否已处理完当前页的所有行
                    if (currentRowIndex >= visibleRows.length) {
                        // 当前页已完成，切换到下一页
                        if (currentPage < totalPages) {
                            currentPage++;
                            showPage(currentPage);
                            
                            // 查找下一页第一个未填的单元格
                            const nextUnfilled = findFirstUnfilledCell();
                            if (nextUnfilled) {
                                currentRowIndex = nextUnfilled.rowIndex;
                                currentQuestionIndex = nextUnfilled.questionIndex;
                            } else {
                                // 下一页也没有未填的，停止
                                stopQuickScoring();
                                return;
                            }
                            
                            setTimeout(autoSelectFirstOption, 300);
                            return;
                        } else {
                            // 所有页面都完成了
                            stopQuickScoring();
                            return;
                        }
                    }
                }
            } else {
                currentRowIndex++;
                currentQuestionIndex = 0;
            }
            
            // 继续下一个选择（稍快一些，但不是秒选）
            if (isQuickScoring) {
                setTimeout(autoSelectFirstOption, 150);
            }
        }
        
        // 查找第一个未填的单元格（行和问题的组合）
        function findFirstUnfilledCell() {
            // 获取当前页面的所有行（按原始顺序）
            const visibleRows = [];
            allRows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    visibleRows.push({ row: row, originalIndex: index });
                }
            });
            
            // 遍历所有可见行，查找第一个未填的单元格
            for (let rowIdx = 0; rowIdx < visibleRows.length; rowIdx++) {
                const rowData = visibleRows[rowIdx];
                const row = rowData.row;
                const btnGroups = row.querySelectorAll('.btn-group');
                
                for (let qIdx = 0; qIdx < btnGroups.length; qIdx++) {
                    const group = btnGroups[qIdx];
                    const radios = group.querySelectorAll('input[type="radio"]');
                    let hasChecked = false;
                    
                    for (let radio of radios) {
                        if (radio.checked) {
                            hasChecked = true;
                            break;
                        }
                    }
                    
                    if (!hasChecked) {
                        // 找到第一个未填的单元格
                        return { rowIndex: rowIdx, questionIndex: qIdx };
                    }
                }
            }
            
            return null; // 所有单元格都已填写
        }
        
        function startQuickScoring() {
            if (isQuickScoring) return;
            
            // 查找第一个未填的单元格，从未填的开始
            const firstUnfilled = findFirstUnfilledCell();
            if (!firstUnfilled) {
                // 所有单元格都已填写
                alert('所有选项都已填写完成！');
                return;
            }
            
            isQuickScoring = true;
            quickScoreBtn.classList.add('active');
            quickScoreBtn.textContent = '填写中';
            
            // 从未填的单元格开始
            currentRowIndex = firstUnfilled.rowIndex;
            currentQuestionIndex = firstUnfilled.questionIndex;
            
            console.log('从未填的单元格开始: 第', currentRowIndex + 1, '行, 第', currentQuestionIndex + 1, '题');
            
            // 开始自动选择
            autoSelectFirstOption();
        }
        
        function stopQuickScoring() {
            isQuickScoring = false;
            quickScoreBtn.classList.remove('active');
            quickScoreBtn.textContent = '按住快填';
            
            if (quickScoreInterval) {
                clearInterval(quickScoreInterval);
                quickScoreInterval = null;
            }
        }
        
        // 触摸事件处理
        quickScoreBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startQuickScoring();
        });
        
        quickScoreBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            stopQuickScoring();
        });
        
        quickScoreBtn.addEventListener('touchcancel', function(e) {
            e.preventDefault();
            stopQuickScoring();
        });
        
        // 鼠标事件处理（用于测试）
        quickScoreBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            startQuickScoring();
        });
        
        quickScoreBtn.addEventListener('mouseup', function(e) {
            e.preventDefault();
            stopQuickScoring();
        });
        
        quickScoreBtn.addEventListener('mouseleave', function(e) {
            e.preventDefault();
            stopQuickScoring();
        });
        
        // 监听分页变化，查找新页面的第一个未填单元格
        window.addEventListener('pagination-change', function() {
            if (isQuickScoring && typeof findFirstUnfilledCell === 'function') {
                const firstUnfilled = findFirstUnfilledCell();
                if (firstUnfilled) {
                    currentRowIndex = firstUnfilled.rowIndex;
                    currentQuestionIndex = firstUnfilled.questionIndex;
                    console.log('分页变化，从未填单元格继续: 第', currentRowIndex + 1, '行, 第', currentQuestionIndex + 1, '题');
                } else {
                    // 新页面没有未填的单元格，停止快速填写
                    stopQuickScoring();
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}